#!/bin/sh
################################
###   Switch RC Code v2.03   ###
### by BPanther, 22-Okt-2022 ###
################################

[ -e /proc/stb/info/model ] && BOXMODEL=`cat /proc/stb/info/model` || exit
[ -e /proc/stb/info/vumodel ] && VUMODEL=`cat /proc/stb/info/vumodel`
if [ "$BOXMODEL" == "dm8000" ]; then
	case $VUMODEL in
		duo4k|solo4k|ultimo4k|uno4k|uno4kse|zero4k)
			BOXMODEL=vuplus;;
	esac
fi

case $BOXMODEL in
	hd51)
		DEFAULT_RC=8;;
	h7)
		DEFAULT_RC=9;;
	bre2ze4k)
		DEFAULT_RC=10;;
	e4hd)
		DEFAULT_RC=11;;
	vuplus)
		DEFAULT_RC=2;;
	*)
		echo "FEHLER: Falsches Boxmodell!" && exit;;
esac

setrccode () {
	case $1 in
	1)  echo 4 > /proc/stb/ir/rc/type
	    echo 4 > /var/etc/rccode;;
	2)  echo 5 > /proc/stb/ir/rc/type
	    echo 5 > /var/etc/rccode;;
	3)  echo 7 > /proc/stb/ir/rc/type
	    echo 7 > /var/etc/rccode;;
	4)  echo 8 > /proc/stb/ir/rc/type
	    echo 8 > /var/etc/rccode;;
	5)  echo 9 > /proc/stb/ir/rc/type
	    echo 9 > /var/etc/rccode;;
	6)  echo 11 > /proc/stb/ir/rc/type
	    echo 11 > /var/etc/rccode;;
	7)  echo 13 > /proc/stb/ir/rc/type
	    echo 13 > /var/etc/rccode;;
	8)  echo 16 > /proc/stb/ir/rc/type
	    echo 16 > /var/etc/rccode;;
	9)  echo 21 > /proc/stb/ir/rc/type
	    echo 21 > /var/etc/rccode;;
	10) echo 23 > /proc/stb/ir/rc/type
	    echo 23 > /var/etc/rccode;;
	11) echo 24 > /proc/stb/ir/rc/type
	    echo 24 > /var/etc/rccode;;
	*)  exit;;
	esac
}

setrccode_vu () {
	case $1 in
		1) echo 1 > /proc/stb/fp/remote_code
		   echo 1 > /var/etc/rccode;;
		2) echo 2 > /proc/stb/fp/remote_code
		   echo 2 > /var/etc/rccode;;
		3) echo 3 > /proc/stb/fp/remote_code
		   echo 3 > /var/etc/rccode;;
		4) echo 4 > /proc/stb/fp/remote_code
		   echo 4 > /var/etc/rccode;;
		*) exit;;
	esac
}

# with parameter "start" -> set only rc code
if [ "$1" == "start" ]; then
	if [ "$BOXMODEL" != "vuplus" ]; then
		[ -e /var/etc/rccode ] && echo -n `cat /var/etc/rccode` > /proc/stb/ir/rc/type
	else
		[ -e /var/etc/rccode ] && echo -n `cat /var/etc/rccode` > /proc/stb/fp/remote_code
	fi
	exit
fi

# plugin menu
TIMEOUT=60
if [ "$BOXMODEL" != "vuplus" ]; then
	msgbox title="Fernbedienung `echo \"$BOXMODEL\" | tr '[a-z]' '[A-Z]'` umschalten" msg="~cFolgende Fernbedienungen stehen zur Auswahl" select="Dreambox,et9000,et5000/et6000,VU+ (Code 0001),et6500/et8000/et9500/et10000,et9200,et4000,et7000/et7500/et8500/HD51,ZGEMMA H7,BRE2ZE 4K, E4HD" default=$DEFAULT_RC
	setrccode $?
	msgbox title="Fernbedienungscode umschalten" msg="~cFunktioniert die Fernbedienung?~n~cIn $TIMEOUT Sekunden wird der Code zurückgesetzt wenn nicht mit \"Ja\" bestätigt." select="Ja,Nein" default=2 timeout=$TIMEOUT
else
	msgbox title="Fernbedienungscode `echo \"$VUMODEL\" | tr '[a-z]' '[A-Z]'` umschalten" msg="~cFolgende Fernbedienungscodes stehen zur Auswahl" select="Code 0001, Code 0002, Code 0003, Code 0004" default=$DEFAULT_RC order=4
	setrccode_vu $?
	msgbox title="Fernbedienungscode umschalten" msg="~cDie Umstellung des Codes der Fernbedienung erfolgt mit:~n~n~cFernbedienung Typ 2/3/4~n~cZiffern 2+7 für ca. 3 Sekunden drücken bis die LED leuchtet, nun Taste HELP drücken.~n~n~cFernbedienung Typ 5/6~n~cTasten POWER+OK für ca. 3 Sekunden drücken bis die LED leuchtet.~n~n~cWeiter für alle FB-Typen~n~cDann 0001, 0002, 0003 oder 0004 drücken für gewünschten Code.~n~n~cFernbedienung Typ 5/6~n~cNun mit OK bestätigen. Die rote LED blinkt 2x zur Bestätigung.~h~n~n~cFunktioniert die Fernbedienung?~n~cIn $TIMEOUT Sekunden wird der Code zurückgesetzt wenn nicht mit \"Ja\" bestätigt." select="Ja,Nein" default=2 timeout=$TIMEOUT
fi

if [ "$?" == "1" ]; then
	exit
else
	[ "$BOXMODEL" != "vuplus" ] && setrccode $DEFAULT_RC || setrccode_vu $DEFAULT_RC
	msgbox title="Fernbedienungscode umschalten" popup="~cOriginaler Fernbedienungscode wiederhergestellt." timeout=5
fi
